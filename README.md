# HanaView - 朝の5分市況チェック

## 概要

HanaViewは、毎朝の市場チェックを5分で完了させることを目的とした金融ダッシュボードです。米国の主要な市場指標、ヒートマップ、関連ニュース、AIによる市況解説などを一画面で確認できます。

データは毎日米国市場のクローズ後に自動で更新されます。

## 主な機能

- **市況概観**: Fear & Greed Index、VIX指数、米国10年債利回りをチャートで表示。
- **AIによる市況解説**: 最新の市場データを基に、OpenAI API (gpt-4o-mini) が市況を簡潔に解説します。
- **ヒートマップ**: NASDAQ 100とS&P 500のパフォーマンスをヒートマップで視覚化。日次、週次、月次での切り替えが可能です。
- **最新ニュース**: 主要な金融ニュースを自動で取得・表示します。
- **経済指標カレンダー**: その日に予定されている重要な経済指標を確認できます。
- **AI週次コラム**: 毎週月曜日に、AIがその週の相場見通しに関するコラムを自動生成します。

## 技術スタックとアーキテクチャ

本アプリケーションは、Dockerコンテナ上で動作するWebアプリケーションです。

- **Backend**:
  - **フレームワーク**: FastAPI (Python)
  - **主なライブラリ**: `yfinance`, `openai`, `curl-cffi`, `beautifulsoup4`
  - **機能**:
    - 金融データ（株価、指標、ニュース）を外部サイトから取得します。
    - OpenAI APIを利用して、市況解説やコラムを生成します。
    - 取得・生成したデータをJSONファイルとして `data` ディレクトリに保存します。
    - フロントエンドにデータを返すAPI (`/api/data`) を提供します。

- **Frontend**:
  - **技術**: HTML, CSS, JavaScript (Vanilla)
  - **主なライブラリ**: `lightweight-charts`
  - **機能**:
    - バックエンドAPIからデータを取得し、ダッシュボード画面をレンダリングします。
    - タブ切り替えやチャートのインタラクティブな表示を提供します。

- **データ更新 (Cron)**:
  - Dockerコンテナ内でcronデーモンが実行されています。
  - 毎日定刻（米国市場クローズ後）に `backend/data_fetcher.py` を実行し、データを更新します。
  - ログは `logs` ディレクトリ内の `cron.log` と `fetch.log` に記録されます。

## 実行方法

### 前提条件

- Docker と Docker Compose がインストールされていること。
- OpenAI APIキーを取得していること。

### 手順

1. **リポジトリのクローン**:
   ```bash
   git clone <repository_url>
   cd <repository_name>
   ```

2. **データ・ログ用ディレクトリの作成**:
   アプリケーションはデータをホストマシンの `./data` ディレクトリに、ログを `./logs` ディレクトリに保存します。これらのディレクトリを手動で作成してください。
   ```bash
   mkdir data logs
   ```

3. **環境変数の設定**:
   `docker-compose.yml` は `OPENAI_API_KEY` という環境変数を参照します。このキーをシェルの環境変数としてエクスポートしてください。
   ```bash
   export OPENAI_API_KEY="sk-..."
   ```
   または、`.env` ファイルを作成して、そこにキーを記述することもできます。
   ```
   # .envファイル
   OPENAI_API_KEY=sk-...
   ```

4. **アプリケーションの起動**:
   以下のコマンドでDockerコンテナをビルドし、バックグラウンドで起動します。
   ```bash
   docker-compose up -d --build
   ```

5. **アクセス**:
   Webブラウザで `http://localhost:8000` を開きます。

6. **アプリケーションの停止**:
   ```bash
   docker-compose down
   ```

## 注意事項

- **cronの実行タイミング**: `crontab` ファイルでは、米国市場の夏時間と冬時間の両方に対応するため、毎日2回データ取得ジョブが設定されています。これは意図した動作ですが、より効率的なスケジューリング（例えば、スクリプト内で実行要否を判断する）も可能です。
- **初回起動時**: 起動直後はデータが存在しないため、画面に「No data available」と表示されることがあります。cronジョブが初めて実行されると、データが生成されて画面に表示されるようになります。すぐに表示を確認したい場合は、以下のコマンドで手動でデータ取得スクリプトを実行できます。
  ```bash
  docker-compose exec app bash -c "cd /app/backend && python data_fetcher.py"
  ```
